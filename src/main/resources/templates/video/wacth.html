<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>个人中心</title>
    <!-- 新 Bootstrap 核心 CSS 文件 -->
    <link href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <!--<link rel="stylesheet" href="/css/register.css" type="text/css" th:href="@{/css/register.css}">-->
    <link rel="stylesheet" href="/css/uikit.css" type="text/css" th:href="@{/css/uikit.css}">
    <link rel="stylesheet" href="" type="text/css" th:href="@{/css/user/grzx.css}">
    <link rel="stylesheet" type="text/css" href="/css/flatpickr.min.css" th:href="@{/css/flatpickr.min.css}">
    <script src="" th:src="@{/js/uikit.min.js}"></script>
    <script src="" th:src="@{/js/jquery-3.2.1.min.js}"></script>
    <link href="//cdn.bootcss.com/video.js/7.0.0-alpha.1/alt/video-js-cdn.css" rel="stylesheet">
    <script src="//cdn.bootcss.com/video.js/7.0.0-alpha.1/video.min.js"></script>
    <script src="" th:src="@{/js/uikit-icons.min.js}"></script>
    <script src="/js/flatpickr.js" th:src="@{/js/flatpickr.js}"></script>
    <script src="/js/addsvg.js" th:src="@{/js/addsvg.js}"></script>
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
<!--<div th:replace="header :: myhead"></div>-->

<div class="main" style="width: 1020px;height: 800px;margin: auto">
        <div class="video">
            <video class="video-js vjs-big-play-centered" controls data-setup="{}" width="660" height="400" preload="auto" th:poster="'/static/'+${session.video.picsrc}">
                <source th:src="@{'/static/'+${session.video.vsrc}}"/>
            </video>
            <div class="vinfo">
               标题： <span>[[${session.video.vtitle}]]</span>
               up主：<span>[[${session.video.scrname}]]</span>
               点赞<span>[[${session.video.goodnum}]]</span>
               观看<span>[[${session.video.looknum}]]</span>
               简介<span>[[${session.video.descript}]]</span>
            </div>
        </div>

    <div class="pl">
        <div class="container" style="margin-top: 10px;margin-bottom: 10px">
            <div class="card mb-3 shadow-lg p-3 bg-white rounded" id="articleCard">
                <div class="card-body">
                    <div id="layout" class="editor">
                        <!--<div id="test-editormd">
                            <textarea></textarea>
                        </div>-->
                    </div>
                </div>
                <div class="card-footer">
                    <form class="mb-3">
                        <div class="form-group">
                    <textarea class="form-control border border-primary" aria-label="With textarea"
                              id="articleCommentContent"></textarea>
                            <div class="invalid-feedback">
                                评论长度不能大于100也不能为空
                            </div>
                        </div>
                        <div class="form-group">
                            <a href="#" class="btn btn-primary disabled" role="button" id="addArticleComment" style="float: right">发表评论</a>
                        </div>
                    </form>

                    <ul class="nav nav-tabs" id="myTab" role="tablist" style="margin-top: 10px">
                        <li class="nav-item">
                            <a class="nav-link active" id="home-tab" data-toggle="tab" href="#commentsLists" role="tab"
                               aria-controls="home" aria-selected="true">评论</a>
                        </li>
                    </ul>
                    <div class="tab-content shadow-lg" id="myTabContent">
                        <div class="tab-pane fade show active" id="commentsLists" role="tabpanel" aria-labelledby="home-tab">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="ReplyComment" tabindex="-1" role="dialog" aria-labelledby="ReplyCommentTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ReplyCommentTitle">回复</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form class="mb-3">
                        <div class="form-group">
                    <textarea class="form-control border border-primary" aria-label="With textarea"
                              id="ReplyCommentContent"></textarea>
                            <div class="invalid-feedback">
                                评论长度不能大于100也不能为空
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="ReplyCommentSend">发表回复</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>
<div th:replace="footer :: myfoot"></div>
</body>
<script th:inline="javascript">
    function getReplyComments(replyCommentList){
        var appendHtml='';
        for(var i in replyCommentList){
            var replyCom=replyCommentList[i];
            appendHtml=appendHtml+'<div class="card">\n' +
                '<div class="row no-gutters">\n' +
                '<div class="card-body">\n' +
                '<h5 class="card-title">' +
                replyCom.user.username+'<small class="text-muted" style="float: right">'+replyCom.createtime+'</small></h5>\n' +
                '<p class="card-text">' +replyCom.content+
                '</p><a href="javascript:showReplyCommentDialog('+replyCom.commentid+','+replyCom.replyuserid+');">回复</a>' +
                '</div>' +
                '</div>' +
                '</div>';
        }
        return appendHtml;
    }
    /*$("#articleCard").hide();*/
    $(document).ready(function () {
        $.post("/comments/getComments", {
            articleid: [[${session.video.vid}]]
        }, function (data, status) {
            console.log(data);
            if(data){
                var appendHtml='';
                for(var i in data){
                    var comments=data[i];
                    appendHtml=appendHtml+'<div class="card">\n' +
                        '<div class="row no-gutters">\n' +
                        '<div class="card-body">\n' +
                        '<h5 class="card-title">' +
                        comments.user.username+'<small class="text-muted" style="float: right">'+comments.createtime+'</small></h5>\n' +
                        '<p class="card-text">' +comments.content+
                        '</p><a href="javascript:showReplyCommentDialog('+comments.id+','+comments.commentuserid+');">回复</a>' +
                        getReplyComments(comments.replyCommentList)+
                        '</div>' +
                        '</div>' +
                        '</div>';
                }
                $("#commentsLists").append(appendHtml);
            }
        });
      /*  if([[${session.loginUser.id}]]==-1){
            $("#articleCommentContent").attr("disabled","disabled");
            $("#articleCommentContent").text("登录后发表评论");
        }*/
    });

    $("#addArticleComment").click(function () {
        if ($("#articleCommentContent").val() != "" && $("#articleCommentContent").val().length <= 100) {
            $.post("/comments/addComments", {
                articleid: [[${session.video.vid}]],
                content: $("#articleCommentContent").val(),
                userid: [[${session.loginUser.id}]],
            }, function (data, status) {
                if(data){
                    window.location.reload();
                }
            });
        }
    });

    $("#ReplyCommentSend").click(function () {
        if($("#ReplyCommentContent").val()!=""&&$("#ReplyCommentContent").val().length<=100){
            addReplyComment($("#ReplyCommentContent").val());
        }

    });
    $("#articleCommentContent").bind("input propertychange", function () {
        if ($("#articleCommentContent").val().length <= 100&&$("#articleCommentContent").val()!="") {
            if ($("#articleCommentContent").hasClass("is-invalid")) {
                $("#articleCommentContent").removeClass("is-invalid");
            }
            if($("#addArticleComment").hasClass("disabled"))
                $("#addArticleComment").removeClass("disabled");
        } else {
            if (!$("#articleCommentContent").hasClass("is-invalid")) {
                $("#articleCommentContent").addClass("is-invalid");
            }
            if(!$("#addArticleComment").hasClass("disabled"))
                $("#addArticleComment").addClass("disabled");
        }
    });
    $("#ReplyCommentContent").bind("input propertychange", function () {
        if ($("#ReplyCommentContent").val().length <= 100&&$("#ReplyCommentContent").val()!="") {
            if ($("#ReplyCommentContent").hasClass("is-invalid")) {
                $("#ReplyCommentContent").removeClass("is-invalid");
            }
            if($("#ReplyCommentSend").hasClass("disabled"))
                $("#ReplyCommentSend").removeClass("disabled");
        } else {
            if (!$("#ReplyCommentContent").hasClass("is-invalid")) {
                $("#ReplyCommentContent").addClass("is-invalid");
            }
            if(!$("#ReplyCommentSend").hasClass("disabled"))
                $("#ReplyCommentSend").addClass("disabled");
        }
    });
    var commentIdCurrent,repliedUserIdCurrent;

    function addReplyComment(content) {
        $.post("/comments/addReplyComment",{
            articleid:[[${session.video.vid}]],
            commentid:commentIdCurrent,
            repliedUserId:repliedUserIdCurrent,
            content:content
        },function (data,status) {
            if(data){
                window.location.reload();
            }
        });
    }

    function showReplyCommentDialog(commentid,replieduserid) {
        if([[${session.loginUser.id}]]!=-1){
            commentIdCurrent=commentid;
            repliedUserIdCurrent=replieduserid;
            $("#ReplyComment").modal("show");
        }else{

        }

    }
</script>

</html>
